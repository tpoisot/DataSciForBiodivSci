<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.386">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Machine Learning for Biodiversity Scientists - 6&nbsp; Variable preparation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": true,
  "collapse-after": 1,
  "panel-placement": "start",
  "type": "overlay",
  "limit": 10,
  "keyboard-shortcut": [
    null
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar docked slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../chapters/variableselection.html"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Selecting variables</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Machine Learning for Biodiversity Scientists</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://github.com/tpoisot/MLBS" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <a href="../Machine-Learning-for-Biodiversity-Scientists.pdf" title="Download PDF" class="quarto-navigation-tool px-1" aria-label="Download PDF"><i class="bi bi-file-pdf"></i></a>
    <div id="quarto-search" class="quarto-navigation-tool px-1" title="Search"></div>
</div>
    </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/clustering.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Clustering</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/gradientdescent.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Gradient descent</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/crossvalidation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Cross-validation</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/classification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Supervised classification</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/variableselection.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Selecting variables</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/learningcurves.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Tuning hyper-parameters</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/explanations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Explaining predictions</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../appendices/instructornotes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Instructor notes</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="-1">
    <h2 id="toc-title">Chapter overview</h2>
   
  <ul>
  <li><a href="#the-problem-optimal-set-of-bioclim-variables-for-the-corsican-nuthatch" id="toc-the-problem-optimal-set-of-bioclim-variables-for-the-corsican-nuthatch" class="nav-link active" data-scroll-target="#the-problem-optimal-set-of-bioclim-variables-for-the-corsican-nuthatch"><span class="header-section-number">6.1</span> The problem: optimal set of BioClim variables for the Corsican nuthatch</a></li>
  <li><a href="#sec-leakage" id="toc-sec-leakage" class="nav-link" data-scroll-target="#sec-leakage"><span class="header-section-number">6.2</span> What is data leakage?</a>
  <ul class="collapse">
  <li><a href="#sec-leakage-consequences" id="toc-sec-leakage-consequences" class="nav-link" data-scroll-target="#sec-leakage-consequences"><span class="header-section-number">6.2.1</span> Consequences of data leakage</a></li>
  <li><a href="#sec-leakage-avoid" id="toc-sec-leakage-avoid" class="nav-link" data-scroll-target="#sec-leakage-avoid"><span class="header-section-number">6.2.2</span> Avoiding data leakage</a></li>
  </ul></li>
  <li><a href="#variable-selection" id="toc-variable-selection" class="nav-link" data-scroll-target="#variable-selection"><span class="header-section-number">6.3</span> Variable selection</a>
  <ul class="collapse">
  <li><a href="#sec-predictors-curse" id="toc-sec-predictors-curse" class="nav-link" data-scroll-target="#sec-predictors-curse"><span class="header-section-number">6.3.1</span> The curse of dimensionality</a></li>
  <li><a href="#step-wise-approaches-to-variable-selection" id="toc-step-wise-approaches-to-variable-selection" class="nav-link" data-scroll-target="#step-wise-approaches-to-variable-selection"><span class="header-section-number">6.3.2</span> Step-wise approaches to variable selection</a></li>
  <li><a href="#forward-selection" id="toc-forward-selection" class="nav-link" data-scroll-target="#forward-selection"><span class="header-section-number">6.3.3</span> Forward selection</a></li>
  <li><a href="#backward-selection" id="toc-backward-selection" class="nav-link" data-scroll-target="#backward-selection"><span class="header-section-number">6.3.4</span> Backward selection</a></li>
  <li><a href="#removal-of-colinear-variables" id="toc-removal-of-colinear-variables" class="nav-link" data-scroll-target="#removal-of-colinear-variables"><span class="header-section-number">6.3.5</span> Removal of colinear variables</a></li>
  </ul></li>
  <li><a href="#multivariate-transformations" id="toc-multivariate-transformations" class="nav-link" data-scroll-target="#multivariate-transformations"><span class="header-section-number">6.4</span> Multivariate transformations</a>
  <ul class="collapse">
  <li><a href="#pca-based-transforms" id="toc-pca-based-transforms" class="nav-link" data-scroll-target="#pca-based-transforms"><span class="header-section-number">6.4.1</span> PCA-based transforms</a></li>
  <li><a href="#whitening-transforms" id="toc-whitening-transforms" class="nav-link" data-scroll-target="#whitening-transforms"><span class="header-section-number">6.4.2</span> Whitening transforms</a></li>
  </ul></li>
  <li><a href="#application-optimal-variables-for-corsican-nuthatch" id="toc-application-optimal-variables-for-corsican-nuthatch" class="nav-link" data-scroll-target="#application-optimal-variables-for-corsican-nuthatch"><span class="header-section-number">6.5</span> Application: optimal variables for Corsican nuthatch</a>
  <ul class="collapse">
  <li><a href="#variable-selection-1" id="toc-variable-selection-1" class="nav-link" data-scroll-target="#variable-selection-1"><span class="header-section-number">6.5.1</span> Variable selection</a></li>
  <li><a href="#variable-transformation" id="toc-variable-transformation" class="nav-link" data-scroll-target="#variable-transformation"><span class="header-section-number">6.5.2</span> Variable transformation</a></li>
  <li><a href="#model-selection" id="toc-model-selection" class="nav-link" data-scroll-target="#model-selection"><span class="header-section-number">6.5.3</span> Model selection</a></li>
  </ul></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion"><span class="header-section-number">6.6</span> Conclusion</a></li>
  <li><a href="#bibliography" id="toc-bibliography" class="nav-link" data-scroll-target="#bibliography">References</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/tpoisot/MLBS/blob/main/chapters/variableselection.qmd" class="toc-action"><i class="bi bi-github"></i>View source</a></li><li><a href="https://github.com/tpoisot/MLBS/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="sec-predictors" class="quarto-section-identifier"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Variable preparation</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>In <a href="classification.html" class="quarto-xref"><span>Chapter&nbsp;5</span></a>, we introduced a simple classifier trained on a dataset of presence and pseudo-absences of a species (<em>Sitta whiteheadi</em>), which we predicted using the mean annual temperature as well as the annual total precipitation. This choice of variables was motivated by our knowledge of the fact that most species tend to have some temperature and precipitation they are best suited to. But we can approach the exercise of selecting predictive variables in a far more formal way, and this will form the core of this chapter. Specifically, we will examine two related techniques: variable selection, and feature engineering.</p>
<p>There are two reasons to think about variable selection and feature engineering – first, the variables we have may not all be predictive for the specific problem we are trying to solve; second, the variables may not be expressed in the correct “way” to solve our problem. This calls for a joint approach of selecting and transforming features. Before we do anything to our features (transformation or selection), we need to talk about data leakage.</p>
<section id="the-problem-optimal-set-of-bioclim-variables-for-the-corsican-nuthatch" class="level2" data-number="6.1">
<h2 data-number="6.1" class="anchored" data-anchor-id="the-problem-optimal-set-of-bioclim-variables-for-the-corsican-nuthatch"><span class="header-section-number">6.1</span> The problem: optimal set of BioClim variables for the Corsican nuthatch</h2>
<p>The BioClim suite of environmental variables are 19 measurements derived from monthly recordings of temperature and precipitation. They are widely used in species distribution modeling, despite some spatial discontinuities due to the methodology of their reconstruction <span class="citation" data-cites="booth2022">(<a href="#ref-booth2022" role="doc-biblioref">Booth 2022</a>)</span>; this is particularly true when working from the WorldClim version <span class="citation" data-cites="fick2017">(<a href="#ref-fick2017" role="doc-biblioref">Fick and Hijmans 2017</a>)</span>, and not as problematic when using other data products like CHELSA <span class="citation" data-cites="karger2017">(<a href="#ref-karger2017" role="doc-biblioref">Karger et al. 2017</a>)</span>.</p>
<p>The definitions of the 19 BioClim variables are given in <a href="#tbl-predictors-bioclim" class="quarto-xref">Table&nbsp;<span>6.1</span></a>. As we can see from this table, a number of variables are either derived from the same months, or direct (even sometimes additive) combinations of one another. For this reason, and because there are 19 variables, this is a good dataset to evaluate the use of variable selection and transformation.</p>
<div id="7df209cc" class="cell" data-execution_count="2">
<div class="cell-output cell-output-display">
<div id="tbl-predictors-bioclim" class="anchored">
<figure class="quarto-float quarto-float-tbl figure">
<div aria-describedby="tbl-predictors-bioclim-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th>Layer</th>
<th>Description</th>
<th>Details</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>BIO1</td>
<td>Annual Mean Temperature</td>
<td></td>
</tr>
<tr class="even">
<td>BIO2</td>
<td>Mean Diurnal Range</td>
<td>Mean of monthly (max temp - min temp)</td>
</tr>
<tr class="odd">
<td>BIO3</td>
<td>Isothermality</td>
<td>(BIO2/BIO7) (×100)</td>
</tr>
<tr class="even">
<td>BIO4</td>
<td>Temperature Seasonality</td>
<td>standard deviation ×100</td>
</tr>
<tr class="odd">
<td>BIO5</td>
<td>Max Temperature of Warmest Month</td>
<td></td>
</tr>
<tr class="even">
<td>BIO6</td>
<td>Min Temperature of Coldest Month</td>
<td></td>
</tr>
<tr class="odd">
<td>BIO7</td>
<td>Temperature Annual Range</td>
<td>(BIO5-BIO6)</td>
</tr>
<tr class="even">
<td>BIO8</td>
<td>Mean Temperature of Wettest Quarter</td>
<td></td>
</tr>
<tr class="odd">
<td>BIO9</td>
<td>Mean Temperature of Driest Quarter</td>
<td></td>
</tr>
<tr class="even">
<td>BIO10</td>
<td>Mean Temperature of Warmest Quarter</td>
<td></td>
</tr>
<tr class="odd">
<td>BIO11</td>
<td>Mean Temperature of Coldest Quarter</td>
<td></td>
</tr>
<tr class="even">
<td>BIO12</td>
<td>Annual Precipitation</td>
<td></td>
</tr>
<tr class="odd">
<td>BIO13</td>
<td>Precipitation of Wettest Month</td>
<td></td>
</tr>
<tr class="even">
<td>BIO14</td>
<td>Precipitation of Driest Month</td>
<td></td>
</tr>
<tr class="odd">
<td>BIO15</td>
<td>Precipitation Seasonality</td>
<td>Coefficient of Variation</td>
</tr>
<tr class="even">
<td>BIO16</td>
<td>Precipitation of Wettest Quarter</td>
<td></td>
</tr>
<tr class="odd">
<td>BIO17</td>
<td>Precipitation of Driest Quarter</td>
<td></td>
</tr>
<tr class="even">
<td>BIO18</td>
<td>Precipitation of Warmest Quarter</td>
<td></td>
</tr>
<tr class="odd">
<td>BIO19</td>
<td>Precipitation of Coldest Quarter</td>
<td></td>
</tr>
</tbody>
</table>
</div>
<figcaption class="table quarto-float-caption quarto-float-tbl" id="tbl-predictors-bioclim-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;6.1: List of the 19 BioClim variables, including indications of their calculation. The model we used in <a href="classification.html" class="quarto-xref"><span>Chapter&nbsp;5</span></a> used BIO1 and BIO12.
</figcaption>
</figure>
</div>
</div>
</div>
<p>In this chapter, we will try to improve the model introduced in <a href="classification.html" class="quarto-xref"><span>Chapter&nbsp;5</span></a>, by evaluating different methods to prepare our predictor variables.</p>
</section>
<section id="sec-leakage" class="level2 page-columns page-full" data-number="6.2">
<h2 data-number="6.2" class="anchored" data-anchor-id="sec-leakage"><span class="header-section-number">6.2</span> What is data leakage?</h2>
<p>Data leakage is a concept that is, if you can believe it, grosser than it sounds.</p>
<p>The purpose of this section is to put the fear of data leakage in you, because it can, and most assuredly <em>will</em>, lead to bad models, which is to say (as we discussed in <a href="gradientdescent.html#sec-gradientdescent-trainedmodel" class="quarto-xref"><span>Section&nbsp;3.1</span></a>), models that do not adequately represent the underlying data, in part because we have built-in some biases into them. In turn, this can eventually lead to decreased explainability of the models, which erodes trust in their predictions <span class="citation" data-cites="amarasinghe2023">(<a href="#ref-amarasinghe2023" role="doc-biblioref">Amarasinghe et al. 2023</a>)</span>. As illustrated by <span class="citation" data-cites="stock2023">Stock, Gregr, and Chan (<a href="#ref-stock2023" role="doc-biblioref">2023</a>)</span>, a large number of ecological applications of machine learning are particularly susceptible to data leakage, meaning that this should be a core point of concern for us.</p>
<section id="sec-leakage-consequences" class="level3" data-number="6.2.1">
<h3 data-number="6.2.1" class="anchored" data-anchor-id="sec-leakage-consequences"><span class="header-section-number">6.2.1</span> Consequences of data leakage</h3>
<p>We take data leakage so seriously because it is one of the top ten mistakes in applied machine learning <span class="citation" data-cites="nisbet2018">(<a href="#ref-nisbet2018" role="doc-biblioref">Nisbet et al. 2018</a>)</span>. Data leakage happens information “leaks” from the training conditions to the evaluation conditions; in other words, when the model is evaluated after mistakenly being fed information that would not be available in real-life situations. Note that this definition of leakage is different from another notion, namely the loss of data availability over time <span class="citation" data-cites="Peterson2018">(<a href="#ref-Peterson2018" role="doc-biblioref">Peterson et al. 2018</a>)</span>.</p>
<p>It is worth stopping for a moment to consider what these “real-life situations” are, and how they differ from the training of the model. Most of this difference can be summarized by the fact that when we are <em>applying</em> a model, we can start from the model <em>only</em>. Which is to say, the data that have been used for the training and validation of the model may have been lost, without changing the applicability of the model: it works on entirely new data. We have discussed this situation in <span class="quarto-unresolved-ref">?sec-crossvalidation-testing</span>: the test of a model is conducted on data that have never been used for training, because we want to evaluate its performance in the conditions where it will be applied.</p>
<p>Because this is the behavior we want to simulate with a validation dataset, it is very important to fully disconnect the testing data from the rest of the data. We can illustrate this with an example. Let’s say we want to work on a time series of population size, such as provided by the <em>BioTIME</em> project <span class="citation" data-cites="dornelas2018">(<a href="#ref-dornelas2018" role="doc-biblioref">Dornelas et al. 2018</a>)</span>. One naïve approach would be to split this the time series at random into three datasets. We can use one to train the models, one to validate these models, and a last one for testing.</p>
<p>Congratulations! We have created data leakage! Because we are splitting our time series at random, the model will likely have been trained using data that date from <em>after</em> the start of the validation dataset. In other words: our model can peek into the future. This is highly unlikely to happen in practice, due to the laws of physics. A strategy that would prevent leakage would have been to pick a cut-off date to define the validation dataset, and then to decide how to deal with the training and testing sets.</p>
</section>
<section id="sec-leakage-avoid" class="level3 page-columns page-full" data-number="6.2.2">
<h3 data-number="6.2.2" class="anchored" data-anchor-id="sec-leakage-avoid"><span class="header-section-number">6.2.2</span> Avoiding data leakage</h3>
<p>The most common advice given in order to prevent data leakage is the “learn/predict separation” <span class="citation" data-cites="kaufman2011">(<a href="#ref-kaufman2011" role="doc-biblioref">Kaufman, Rosset, and Perlich 2011</a>)</span>. Simply put, this means that whatever happens to the data used for training cannot be <em>simultaneously</em> applied to the data used for testing (or validation).</p>
<div class="content-margin">
<p>A counter-example where performing the transformation <em>before</em> the analysis is when the transformation is explicitly sought out as an embedding, where we want to predict the position of instances in the embedded space, as in <em>.e.g.</em> <span class="citation" data-cites="runghen2022">Runghen, Stouffer, and Dalla Riva (<a href="#ref-runghen2022" role="doc-biblioref">2022</a>)</span>.</p>
</div>
<p>Assume that we want to transform our data using a Principal Component Analysis (PCA; <span class="citation" data-cites="pearson1901">Pearson (<a href="#ref-pearson1901" role="doc-biblioref">1901</a>)</span>). Ecologists often think of PCA as a technique to explore data <span class="citation" data-cites="legendre2012">(<a href="#ref-legendre2012" role="doc-biblioref">Legendre and Legendre 2012</a>)</span>, but it is so much more than that! PCA is a model, because we can derive, from the data, a series of weights (in the transformation matrix), which we can then apply to other datasets in order to project them in the space of the projection of the training data.</p>
<p>If we have a dataset <span class="math inline">\(\mathbf{X}\)</span>, which we split into two components <span class="math inline">\(\mathbf{X}_0\)</span> for training ,and <span class="math inline">\(\mathbf{X}_1\)</span> for validation, there are two ways to use a PCA to transform these data. The first is <span class="math inline">\(\mathbf{T} = \mathbf{X}\mathbf{W}\)</span>, which uses the full dataset. When we predict the position of the validation data, we could use the transformation <span class="math inline">\(\mathbf{T}_1 = \mathbf{X}_1\mathbf{W}\)</span>, but this would introduce data leakage: we have trained the transformation we apply to <span class="math inline">\(\mathbf{X}_1\)</span> using data that are already in <span class="math inline">\(\mathbf{X}_1\)</span>, and therefore we have not respected the learn/predict separation. This way to introduce data leakage is extremely common in the species distribution literature <span class="citation" data-cites="demarco2018">(see <em>e.g.</em> <a href="#ref-demarco2018" role="doc-biblioref">De Marco and Nóbrega 2018</a>)</span>.</p>
<div id="fig-predictors-leakage" class="quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-predictors-leakage-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../diagrams/data-leakage.png" class="img-fluid figure-img">
</div>
<figcaption class="figure quarto-float-caption quarto-float-fig margin-caption" id="fig-predictors-leakage-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6.1: Overview of a data transformation pipeline that introduces data leakage (left), or that does not introduce data leakage (right). In both cases, a transformation such as a PCA is applied to the data; in the example on the right, it is applied as part of the model, and can therefore be applied without breaking the train/predict separation. The pipeline on the left introduces data leakage, as the training data will be changed by information contained in the validation data.
</figcaption>
</figure>
</div>
<p>The second (correct) way to handle this situation is to perform our PCA using <span class="math inline">\(\mathbf{T}_0 = \mathbf{X}_0\mathbf{W}_0\)</span>, which is to say, the weights of our PCA are derived <em>only</em> from the training data. In this situation, whenever we project the data in the validation set using <span class="math inline">\(\mathbf{T}_1 = \mathbf{X}_1\mathbf{W}_0\)</span>, we respect the learn/predict separation: the transformation of <span class="math inline">\(\mathbf{X}_1\)</span> is entirely independent from the data contained in <span class="math inline">\(\mathbf{X}_1\)</span>. This is illustrated in <a href="#fig-predictors-leakage" class="quarto-xref">Figure&nbsp;<span>6.1</span></a>.</p>
<section id="how-to-work-in-practice" class="level4" data-number="6.2.2.1">
<h4 data-number="6.2.2.1" class="anchored" data-anchor-id="how-to-work-in-practice"><span class="header-section-number">6.2.2.1</span> How to work in practice?</h4>
<p>Although avoiding data leakage is a tricky problem, there is a very specific mindset we can adopt that goes a long way towards not introducing it in our analyses, and it is as follows: <em>every data transformation step is a modeling step that is part of the learning process</em>. We do not, for example, apply a PCA and train the model on the projected variables – we feed raw data into a model, the first step of which is to perform this PCA for us.</p>
<p>This approach works because everything that can be represented as numbers is a model that can be trained.</p>
<p>If you want to transform a variable using the z-score, this is a model! It has two parameters that you can learn from the data, <span class="math inline">\(\mu\)</span> (the average of the variable) and <span class="math inline">\(\sigma\)</span> (its standard deviation). You can apply it to a data point <span class="math inline">\(y\)</span> with <span class="math inline">\(\hat y = (y - \mu)\sigma^{-1}\)</span>. Because this is a model, we need a dataset to learn these parameters from, and because we want to maintain the learn/predict separation, we will use the train dataset to get the values of <span class="math inline">\(\mu_0\)</span> and <span class="math inline">\(\sigma_0\)</span>. This way, when we want to get the z-score of a new observation, for example from the testing dataset, we can get it using <span class="math inline">\(\hat y_1 = (y_1 - \mu_0)\sigma_0^{-1}\)</span>. The data transformation is entirely coming from information that was part of the training set.</p>
<p>One way to get the learn/predict transformation stupendously wrong is to transform our validation, testing, or prediction data using <span class="math inline">\(\hat y_1 = (y_1 - \mu_1)\sigma_1^{-1}\)</span>. This can be easily understood with an example. Assume that the variable <span class="math inline">\(y_0\)</span> is the temperature in our training dataset. We are interested in making a prediction in a world that is 2 degrees hotter, uniformly, which is to say that for whatever value of <span class="math inline">\(y_0\)</span>, the corresponding data point we use for prediction is <span class="math inline">\(y_1 = y_0 + 2\)</span>. If we take the z-score of this new value based on its own average and standard deviation, a temperature two degrees warmer in the prediction data will have the same z-score as its original value, or in other words, we have hidden the fact that there is a change in our predictors!</p>
<p>Treating the data preparation step as a part of the learning process, which is to say that we learn every transformation on the training set, and retain this transformation as part of the prediction process, we are protecting ourselves against both data leakage <em>and</em> the hiding of relevant changes in our predictors.</p>
</section>
</section>
</section>
<section id="variable-selection" class="level2" data-number="6.3">
<h2 data-number="6.3" class="anchored" data-anchor-id="variable-selection"><span class="header-section-number">6.3</span> Variable selection</h2>
<section id="sec-predictors-curse" class="level3" data-number="6.3.1">
<h3 data-number="6.3.1" class="anchored" data-anchor-id="sec-predictors-curse"><span class="header-section-number">6.3.1</span> The curse of dimensionality</h3>
<p>The number of variables we use for prediction is the number of dimensions of a problem. It would be tempting to say that adding dimensions should improve our chances to find a feature alongside which the classes become linearly separable. If only!</p>
<p>The “curse of dimensionality” is the common term of everything breaking down when the dimensions of a problem increase. In our perspective, where we rely on the resemblance between features to make a prediction, increasing the dimensions of a problem means adding features, and it has important consequences on the distance between observations. Picture two points positioned at random on the unit interval: the average distance between them is 1/3. If we add one dimension, keeping two points but turning this line into a cube, the average distance would be about 1/2. For a cube, about 2/3. For <span class="math inline">\(n\)</span> dimensions, we can figure out that the average distance grows like <span class="math inline">\(\sqrt{n/6 + c}\)</span>, which is to say that when we add more dimensions, we make the average distance between two points go to infinity. This effect is also affecting ecological studies <span class="citation" data-cites="smith2017">(<em>e.g.</em> <a href="#ref-smith2017" role="doc-biblioref">Smith et al. 2017</a>)</span>.</p>
<p>Therefore, we need to approach the problem of “which variables to use” with a specific mindset: we want a lot of information for our model, but not so much that the space in which the predictors exist turns immense. There are techniques for this.</p>
</section>
<section id="step-wise-approaches-to-variable-selection" class="level3" data-number="6.3.2">
<h3 data-number="6.3.2" class="anchored" data-anchor-id="step-wise-approaches-to-variable-selection"><span class="header-section-number">6.3.2</span> Step-wise approaches to variable selection</h3>
<p>In order to try and decrease the dimensionality of a problem, we can attempt to come up with a method to decide which variables to include, or to remove, from a model. This practice is usually called “stepwise” selection, and is the topic of <em>intense</em> debate in ecology, although several studies point to the fact that there is rarely a best technique to select variables <span class="citation" data-cites="murtaugh2009">(<a href="#ref-murtaugh2009" role="doc-biblioref">Murtaugh 2009</a>)</span>, that the same data can usually be adequately described by competing models <span class="citation" data-cites="whittingham2006">(<a href="#ref-whittingham2006" role="doc-biblioref">WHITTINGHAM et al. 2006</a>)</span>, and that classifiers can show high robustness to the inclusion of non-informative variables <span class="citation" data-cites="fox2017">(<a href="#ref-fox2017" role="doc-biblioref">Fox et al. 2017</a>)</span>. Situations in which variable selection has been shown top be useful is the case of model transfer <span class="citation" data-cites="petitpierre2016">(<a href="#ref-petitpierre2016" role="doc-biblioref">Petitpierre et al. 2016</a>)</span>, or (when informed by ecological knowledge), the demonstration that classes of variables had no measurable impact on model performance <span class="citation" data-cites="thuiller2004">(<a href="#ref-thuiller2004" role="doc-biblioref">Thuiller, Araújo, and Lavorel 2004</a>)</span>.</p>
<p>Why, so, should we select the variables we put in our models?</p>
<p>The answer is simple: we seek to solve a specific problem in an optimal way, where “optimal” refers to the maximization of a performance measure we decided upon <em>a priori</em>. In our case, this is the MCC. Therefore, an ideal set of predictors is the one that, given our cross-validation strategy, maximizes our measure of performance.</p>
</section>
<section id="forward-selection" class="level3" data-number="6.3.3">
<h3 data-number="6.3.3" class="anchored" data-anchor-id="forward-selection"><span class="header-section-number">6.3.3</span> Forward selection</h3>
<p>In forward selection, assuming that we have <span class="math inline">\(f\)</span> features, we start by building <span class="math inline">\(f\)</span> models, each using one feature. For example, using the BioClim variables, <span class="math inline">\(m_1\)</span> would be attempting to predict presences and absences based only on temperature. Out of these models, we retain the variable given by <span class="math inline">\(\text{argmax}_f \text{MCC}(m_f)\)</span>, where <span class="math inline">\(\text{MCC}(m_f)\)</span> is the average value of MCC for the <span class="math inline">\(f\)</span>-th model on the validation datasets. This is the first variable we add to our set of selected variables. We then train <span class="math inline">\(f-1\)</span> models, and then again add the variable that leads to the best possible <em>increase</em> in the average value of the MCC. When we cannot find a remaining variable that would increase the performance of the model, we stop the process, and return the optimal set of variables. Forward selection can be constrained by, instead of starting from variables one by one, starting from a pre-selected set of variables that will always be included in the model.</p>
<p>There are two important things to consider here. First, the set of variables is only optimal under the assumptions of the stepwise selection process: the first variable is the one that boosts the predictive value of the model the most <em>on its own</em>, and the next variables <em>in the context of already selected variables</em>. Second, the variables are evaluated on the basis of their ability to <em>improve the performance of the model</em>; this does not imply that they are relevant to the ecological processes happening in the dataset. Infering mechanisms on the basis of variable selection is foolish <span class="citation" data-cites="tredennick2021">(<a href="#ref-tredennick2021" role="doc-biblioref">Tredennick et al. 2021</a>)</span>.</p>
</section>
<section id="backward-selection" class="level3" data-number="6.3.4">
<h3 data-number="6.3.4" class="anchored" data-anchor-id="backward-selection"><span class="header-section-number">6.3.4</span> Backward selection</h3>
<p>The opposite of forward selection is backward selection, in which we start from a complete set of variables, then remove the one with the <em>worst</em> impact on model performance, and keep proceeding until we cannot remove a variable without making the model worse. The set of variables that remain will be the optimal set of variables. In almost no cases will forward and backward selection agree on which set of variables is the best – we have to settle this debate by either picking the model with the least parameters (the most parsimonious), or the one with the best performance.</p>
<p>Why not evaluate all the combination of variables?</p>
<p>Keep in mind that we do not know the number of variables we should use; therefore, for the 19 BioClim variables, we would have to evaluate <span class="math inline">\(\sum_f \binom{19}{f}\)</span>, which turns out to be an <em>immense</em> quantity (for example, <span class="math inline">\(\binom{19}{9}=92378\)</span>). For this reason, a complete enumeration of all variable combinations would be extremely wasteful.</p>
</section>
<section id="removal-of-colinear-variables" class="level3" data-number="6.3.5">
<h3 data-number="6.3.5" class="anchored" data-anchor-id="removal-of-colinear-variables"><span class="header-section-number">6.3.5</span> Removal of colinear variables</h3>
<p>Co-linearity of variables is challenging for all types of ecological models <span class="citation" data-cites="graham2003">(<a href="#ref-graham2003" role="doc-biblioref">Graham 2003</a>)</span>. In the case of species distribution models <span class="citation" data-cites="demarco2018">(<a href="#ref-demarco2018" role="doc-biblioref">De Marco and Nóbrega 2018</a>)</span>, the variables are expected to be strongly auto-correlated, both because they have innate spatial auto-correlation, and because they are derived from a smaller set of raw data <span class="citation" data-cites="dormann2012">(<a href="#ref-dormann2012" role="doc-biblioref">Dormann et al. 2012</a>)</span>. For this reason, it is a good idea to limit the number of colinear variables. In the BioClim variables, there</p>
</section>
</section>
<section id="multivariate-transformations" class="level2" data-number="6.4">
<h2 data-number="6.4" class="anchored" data-anchor-id="multivariate-transformations"><span class="header-section-number">6.4</span> Multivariate transformations</h2>
<section id="pca-based-transforms" class="level3" data-number="6.4.1">
<h3 data-number="6.4.1" class="anchored" data-anchor-id="pca-based-transforms"><span class="header-section-number">6.4.1</span> PCA-based transforms</h3>
<p>Principal Component Analysis (PCA) is one of the most widely used multi-variate techniques in ecology, and is a very common technique to prepare variables in applied machine learning. One advantage of PCA is that it serves both as a way to remove colinearity, in that the principal components are orthogonal, and as a way to reduce the dimensionality of the problem as long as we decide on a threshold on the proportion of variance explained, and only retain the number of principal components needed to reach this threshold. For applications where the features are high-dimensional, PCA is a well established method to reduce dimensionality <em>and</em> extract more information in the selected principal components <span class="citation" data-cites="howley2005">(<a href="#ref-howley2005" role="doc-biblioref">Howley et al. 2005</a>)</span>. In PCA, the projection matrix <span class="math inline">\(\mathbf{P}\)</span> is applied to the data using <span class="math inline">\(\mathbf{P}^\top(\mathbf{x}-\mathbf{\mu})\)</span>, where <span class="math inline">\(\mathbf{x}\)</span> is the feature matrix with means <span class="math inline">\(\mathbf{\mu}\)</span>. Typically, the dimensions of <span class="math inline">\(\mathbf{P}\)</span> are <em>lower</em> than the dimensions of <span class="math inline">\(\mathbf{x}\)</span>, resulting in fewer dimensions to the problem. Cutoffs on the dimensions of <span class="math inline">\(\mathbf{P}\)</span> are typically expressed as a proportion of the overall variance maintained after the projection. Variants of PCA include kernel PCA <span class="citation" data-cites="schölkopf1998">(<a href="#ref-schölkopf1998" role="doc-biblioref">Schölkopf, Smola, and Müller 1998</a>)</span>, using a higher-dimensional space to improve the separability of classes, and probabilistic PCA <span class="citation" data-cites="tipping1999">(<a href="#ref-tipping1999" role="doc-biblioref">Tipping and Bishop 1999</a>)</span>, which relies on modeling the data within a latent space with lower dimensionality.</p>
</section>
<section id="whitening-transforms" class="level3" data-number="6.4.2">
<h3 data-number="6.4.2" class="anchored" data-anchor-id="whitening-transforms"><span class="header-section-number">6.4.2</span> Whitening transforms</h3>
<p>Another class of potentially very useful data transformations is whitening transforms, which belongs to the larger category of decorrelation methods. These methods do not perform any dimensionality reduction, but instead remove the covariance in the datasets. Whitening has proven to be particularly effective at improving the predictive ability of models applied to data with strong covariance structure <span class="citation" data-cites="koivunen1999">(<a href="#ref-koivunen1999" role="doc-biblioref">Koivunen and Kostinski 1999</a>)</span>. In essence, given a matrix of features <span class="math inline">\(\mathbf{x}\)</span>, with averages <span class="math inline">\(\mathbf{\mu}\)</span> and covariance <span class="math inline">\(\mathbf{C}\)</span>, a whitening transform <span class="math inline">\(\mathbf{W}\)</span> is the <em>one of the matrices</em> that satisfies <span class="math inline">\(\mathbf{W}^\top\mathbf{C}\mathbf{W} = \mathbf{I}\)</span>. In other words, the whitening transform results in a new set of features with unit variance and no covariance: the dimensionality of the problem remains the same but the new random variables are independent. Given any dataset with covariance matrix <span class="math inline">\(\mathbf{C}\)</span>, if any <span class="math inline">\(\mathbf{W}\)</span> is a whitening transform, then so to are any matrices <span class="math inline">\(\mathbf{W}\mathbf{R}\)</span> where <span class="math inline">\(\mathbf{R}\)</span> performs a rotation with <span class="math inline">\(\mathbf{R}^\top\mathbf{R} = \mathbf{I}\)</span>. The optimal whitening transform can be derived through a variety of ways <span class="citation" data-cites="kessy2018">(see <em>e.g.</em> <a href="#ref-kessy2018" role="doc-biblioref">Kessy, Lewin, and Strimmer 2018</a>)</span>. The whitening transform is applied to the input vector using <span class="math inline">\(\mathbf{W}^\top (\mathbf{x}-\mathbf{\mu})\)</span>: this results in new random variables that have a mean of 0, and unit variance. The new input vector after the transformation is therefore an instance of “white noise” <span class="citation" data-cites="vasseur2004">(<a href="#ref-vasseur2004" role="doc-biblioref">Vasseur and Yodzis 2004</a>)</span>.</p>
</section>
</section>
<section id="application-optimal-variables-for-corsican-nuthatch" class="level2 page-columns page-full" data-number="6.5">
<h2 data-number="6.5" class="anchored" data-anchor-id="application-optimal-variables-for-corsican-nuthatch"><span class="header-section-number">6.5</span> Application: optimal variables for Corsican nuthatch</h2>
<p>Before we start, we can re-establish the baseline performance of the model from <a href="classification.html" class="quarto-xref"><span>Chapter&nbsp;5</span></a>. In this (and the next) chapters, we will perform k-folds cross-validation (see <span class="quarto-unresolved-ref">?sec-crossvalidation-kfolds</span> for a refresher), using <span class="math inline">\(k=15\)</span>. This strategy gives an average MCC of 0.76, which represents our “target”: any model with a higher MCC will be “better” according to our criteria.</p>
<p>In a sense, this initial model was <em>already</em> coming from a variable selection process, only we did not use a quantitative criteria to include variables. And so, it is a good idea to evaluate how our model performed, relative to a model including <em>all</em> the variables. Running the NBC again using all 19 BioClim variables from <a href="#tbl-predictors-bioclim" class="quarto-xref">Table&nbsp;<span>6.1</span></a>, we get an average MCC on the validation data of 0.794. This is a small increase, but an increase nevertheless – our dataset had information that was not captured by temperature and precipitation. But this model with all the variables most likely includes extraneous information that does not help, or even hinders, the predictive ability of our model. Therefore, there is probably a better version of the model somewhere, that uses the optimal set of variables, potentially with the best possible transformation applied to them.</p>
<p>In this section, we will start by evaluating the efficiency of different approaches to variable selection, then merge selection and transformation together to provide a model that is optimal with regards to the training data we have (the workflow is outlined in <a href="#fig-predictors-workflow" class="quarto-xref">Figure&nbsp;<span>6.2</span></a>). In order to evaluate the model, we will maintain the use of the MCC; in addition, we will report the PPV and NPV (like in <a href="classification.html" class="quarto-xref"><span>Chapter&nbsp;5</span></a>), as well as the accuracy and True-Skill Statistic (TSS). The TSS is defined as the sum of true positive and true negative rates, minus one, and is an alternative measure to the MCC (although it is more sensitive to some biases). Although several authors have advocated for the use of TSS <span class="citation" data-cites="allouche2006">(<a href="#ref-allouche2006" role="doc-biblioref">ALLOUCHE, TSOAR, and KADMON 2006</a>)</span>, <span class="citation" data-cites="leroy2018">Leroy et al. (<a href="#ref-leroy2018" role="doc-biblioref">2018</a>)</span> have an interesting discussion of how the TSS is particularly sensitive to issues in the quality of (pseudo) absence data. For this reason, and based on the literature we covered in <a href="classification.html" class="quarto-xref"><span>Chapter&nbsp;5</span></a>, there is no strong argument against using MCC as our selection measure.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>In <a href="learningcurves.html" class="quarto-xref"><span>Chapter&nbsp;7</span></a>, we will revisit the question of how the MCC is “better”, and spend more time evaluating alternatives. For now, we can safely <em>assume</em> that MCC is the best.</p>
</div></div><p>To prevent the risk of interpreting the list of variables that have been retained by the model, we will <em>not</em> make a list of which they are (yet). This is because, in order to discuss the relative importance of variables, we need to introduce a few more concepts and techniques, which will not happen until <a href="explanations.html" class="quarto-xref"><span>Chapter&nbsp;8</span></a>; at this point, we will revisit the list of variables identified during this chapter, and compare their impact on model performance to their actual importance in explaining predictions.</p>
<div id="fig-predictors-workflow" class="quarto-figure quarto-figure-center anchored page-columns page-full" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-predictors-workflow-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../diagrams/variable-selection.png" class="img-fluid quarto-figure-center figure-img">
</div>
<figcaption class="figure quarto-float-caption quarto-float-fig margin-caption" id="fig-predictors-workflow-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6.2: Overview of the variable selection workflow; starting from a list of variables and a routine to select them, we will perform cross-validation and measure whether the model performance increases.
</figcaption>
</figure>
</div>
<section id="variable-selection-1" class="level3" data-number="6.5.1">
<h3 data-number="6.5.1" class="anchored" data-anchor-id="variable-selection-1"><span class="header-section-number">6.5.1</span> Variable selection</h3>
<p>We will perform four different versions of stepwise variable selection. Forward, forward from a pre-selected set of two variables (temperature and precipitation), backward, and based on the Variance Inflation Factor (with a cutoff of 10). The results are presented in <a href="#tbl-predictors-selection" class="quarto-xref">Table&nbsp;<span>6.2</span></a>.</p>
<div id="7ad8b214" class="cell" data-execution_count="6">
<div class="cell-output cell-output-display">
<div id="tbl-predictors-selection" class="anchored">
<figure class="quarto-float quarto-float-tbl figure">
<div aria-describedby="tbl-predictors-selection-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
</colgroup>
<thead>
<tr class="header">
<th>Model</th>
<th>Variables</th>
<th>MCC</th>
<th>NPV</th>
<th>PPV</th>
<th>Acc.</th>
<th>TSS</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><a href="classification.html" class="quarto-xref"><span>Chapter&nbsp;5</span></a> baseline</td>
<td>2</td>
<td>0.76</td>
<td>0.859</td>
<td>0.901</td>
<td>0.881</td>
<td>0.76</td>
</tr>
<tr class="even">
<td>All var.</td>
<td>19</td>
<td>0.794</td>
<td>0.871</td>
<td>0.922</td>
<td>0.897</td>
<td>0.795</td>
</tr>
<tr class="odd">
<td>Fwd.</td>
<td>6</td>
<td>0.848</td>
<td>0.901</td>
<td>0.946</td>
<td>0.924</td>
<td>0.849</td>
</tr>
<tr class="even">
<td>Fwd. (constr.)</td>
<td>8</td>
<td>0.83</td>
<td>0.888</td>
<td>0.94</td>
<td>0.915</td>
<td>0.832</td>
</tr>
<tr class="odd">
<td>Backw.</td>
<td>9</td>
<td>0.846</td>
<td>0.901</td>
<td>0.944</td>
<td>0.923</td>
<td>0.847</td>
</tr>
<tr class="even">
<td>VIF</td>
<td>2</td>
<td>0.466</td>
<td>0.793</td>
<td>0.708</td>
<td>0.736</td>
<td>0.434</td>
</tr>
</tbody>
</table>
</div>
<figcaption class="table quarto-float-caption quarto-float-tbl" id="tbl-predictors-selection-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;6.2: Consequences of different variable selection approaches on the performance of the model, as evaluated by the MCC, NPV, PPV, accuracy, and True-Skill Statistic (TSS).
</figcaption>
</figure>
</div>
</div>
</div>
<p>The best model is given by forward selection, although backwards selection also gives a very close performance. At this point, we may decide to keep these two strategies, and evaluate the effect of different transformations of the data.</p>
</section>
<section id="variable-transformation" class="level3" data-number="6.5.2">
<h3 data-number="6.5.2" class="anchored" data-anchor-id="variable-transformation"><span class="header-section-number">6.5.2</span> Variable transformation</h3>
<p>Based on the results from <a href="#tbl-predictors-selection" class="quarto-xref">Table&nbsp;<span>6.2</span></a>, we retain forward and backwards selection as our two stepwise selection methods, and now apply an additional transformation (as in <a href="#fig-predictors-workflow" class="quarto-xref">Figure&nbsp;<span>6.2</span></a>) to the subset of the variables. The results are presented in <a href="#tbl-predictors-transformation" class="quarto-xref">Table&nbsp;<span>6.3</span></a>. Based on these results, and using the MCC as the criteria for the “best” model, we see that combining forward selection with a whitening transform gives the best predictive performance. Note that the application of a transformation <em>does</em> change the result of variable selection, as evidences by the fact that the number of retained variables changes when we apply a transformation.</p>
<div id="d6027750" class="cell" data-execution_count="7">
<div class="cell-output cell-output-display">
<div id="tbl-predictors-transformation" class="anchored">
<figure class="quarto-float quarto-float-tbl figure">
<div aria-describedby="tbl-predictors-transformation-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 13%">
<col style="width: 13%">
<col style="width: 8%">
<col style="width: 13%">
<col style="width: 13%">
<col style="width: 13%">
<col style="width: 13%">
<col style="width: 13%">
</colgroup>
<thead>
<tr class="header">
<th>Selection</th>
<th>Transformation</th>
<th>Variables</th>
<th>MCC</th>
<th>NPV</th>
<th>PPV</th>
<th>Acc.</th>
<th>TSS</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Fwd.</td>
<td>PCA</td>
<td>4</td>
<td>0.853</td>
<td>0.898</td>
<td>0.952</td>
<td>0.926</td>
<td>0.855</td>
</tr>
<tr class="even">
<td>Fwd.</td>
<td>Whitening</td>
<td>10</td>
<td>0.877</td>
<td>0.918</td>
<td>0.956</td>
<td>0.938</td>
<td>0.878</td>
</tr>
<tr class="odd">
<td>Fwd.</td>
<td>Raw data</td>
<td>6</td>
<td>0.848</td>
<td>0.901</td>
<td>0.946</td>
<td>0.924</td>
<td>0.849</td>
</tr>
<tr class="even">
<td>Backw.</td>
<td>PCA</td>
<td>13</td>
<td>0.835</td>
<td>0.888</td>
<td>0.943</td>
<td>0.918</td>
<td>0.838</td>
</tr>
<tr class="odd">
<td>Backw.</td>
<td>Whitening</td>
<td>15</td>
<td>0.869</td>
<td>0.913</td>
<td>0.953</td>
<td>0.934</td>
<td>0.871</td>
</tr>
<tr class="even">
<td>Backw.</td>
<td>Raw data</td>
<td>9</td>
<td>0.846</td>
<td>0.901</td>
<td>0.944</td>
<td>0.923</td>
<td>0.847</td>
</tr>
</tbody>
</table>
</div>
<figcaption class="table quarto-float-caption quarto-float-tbl" id="tbl-predictors-transformation-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;6.3: Model performance when coupling variable selection with variable transformation. The measures of performance are given as in <a href="#tbl-predictors-selection" class="quarto-xref">Table&nbsp;<span>6.2</span></a>, and as we use the same folds for validation, can be directly compared.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="model-selection" class="level3 page-columns page-full" data-number="6.5.3">
<h3 data-number="6.5.3" class="anchored" data-anchor-id="model-selection"><span class="header-section-number">6.5.3</span> Model selection</h3>
<p>In <a href="#tbl-predictors-selection" class="quarto-xref">Table&nbsp;<span>6.2</span></a> and <span class="quarto-unresolved-ref">?tbl-predictions-transformation</span>, we have evaluated a series of several modeling strategies, defined by a variable selection and transformation technique. Using the MCC as our reference for what constitutes the best model, we can now apply the model to the relevant set of predictors, in order to see how these refinements result in a new predicted range for the species.</p>
<p>These results are presented in <a href="#fig-predictors-rangediff" class="quarto-xref">Figure&nbsp;<span>6.3</span></a>.</p>
<div id="cell-fig-predictors-rangediff" class="cell page-columns page-full" data-execution_count="9">
<div class="cell-output cell-output-display page-columns page-full" data-execution_count="11">
<div id="fig-predictors-rangediff" class="quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-predictors-rangediff-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="variableselection_files/figure-html/fig-predictors-rangediff-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="figure quarto-float-caption quarto-float-fig margin-caption" id="fig-predictors-rangediff-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6.3: Consequences of different variable transformations on the predicted range of <em>Sitta whiteheadi</em>, as introduced in <a href="classification.html#fig-classification-range" class="quarto-xref">Figure&nbsp;<span>5.4</span></a>. Note that the small area of predicted presence in the Cap Corse (the Northern tip) has disappeared with the new set of variables and their optimal transformation.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="conclusion" class="level2" data-number="6.6">
<h2 data-number="6.6" class="anchored" data-anchor-id="conclusion"><span class="header-section-number">6.6</span> Conclusion</h2>
<p>In this chapter, we have discussed the issues with dimensionality and data leakage, and established a methodology to reduce the number of dimensions (and possible re-project the variables) while maintaining the train/predict separation. This resulted in a model whose performance (as evaluated using the MCC) increased quite significantly, which resulted in the predicted range of <em>Sitta whiteheadi</em> changing in space.</p>
<p>In <a href="learningcurves.html" class="quarto-xref"><span>Chapter&nbsp;7</span></a>, we will finish to refine this model, by considering that the NBC is a probabilistic classifier, and tuning various hyper-parameters of the model using learning curves and thresholding. This will result in the final trained model, the behavior of which we will explore in <a href="explanations.html" class="quarto-xref"><span>Chapter&nbsp;8</span></a>, to understand <em>how</em> the model makes predictions.</p>


</section>
<section id="bibliography" class="level1 unnumbered">
<h1 class="unnumbered">References</h1>
<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-allouche2006" class="csl-entry" role="listitem">
ALLOUCHE, OMRI, ASAF TSOAR, and RONEN KADMON. 2006. <span>“Assessing the Accuracy of Species Distribution Models: Prevalence, Kappa and the True Skill Statistic (TSS).”</span> <em>Journal of Applied Ecology</em> 43 (6): 1223–32. <a href="https://doi.org/10.1111/j.1365-2664.2006.01214.x">https://doi.org/10.1111/j.1365-2664.2006.01214.x</a>.
</div>
<div id="ref-amarasinghe2023" class="csl-entry" role="listitem">
Amarasinghe, Kasun, Kit T. Rodolfa, Hemank Lamba, and Rayid Ghani. 2023. <span>“Explainable Machine Learning for Public Policy: Use Cases, Gaps, and Research Directions.”</span> <em>Data &amp; Policy</em> 5. <a href="https://doi.org/10.1017/dap.2023.2">https://doi.org/10.1017/dap.2023.2</a>.
</div>
<div id="ref-booth2022" class="csl-entry" role="listitem">
Booth, Trevor H. 2022. <span>“Checking Bioclimatic Variables That Combine Temperature and Precipitation Data Before Their Use in Species Distribution Models.”</span> <em>Austral Ecology</em> 47 (7): 1506–14. <a href="https://doi.org/10.1111/aec.13234">https://doi.org/10.1111/aec.13234</a>.
</div>
<div id="ref-demarco2018" class="csl-entry" role="listitem">
De Marco, Paulo, and Caroline Corrêa Nóbrega. 2018. <span>“Evaluating Collinearity Effects on Species Distribution Models: An Approach Based on Virtual Species Simulation.”</span> Edited by Luciano Bosso. <em>PLOS ONE</em> 13 (9): e0202403. <a href="https://doi.org/10.1371/journal.pone.0202403">https://doi.org/10.1371/journal.pone.0202403</a>.
</div>
<div id="ref-dormann2012" class="csl-entry" role="listitem">
Dormann, Carsten F., Jane Elith, Sven Bacher, Carsten Buchmann, Gudrun Carl, Gabriel Carré, Jaime R. García Marquéz, et al. 2012. <span>“Collinearity: A Review of Methods to Deal with It and a Simulation Study Evaluating Their Performance.”</span> <em>Ecography</em> 36 (1): 27–46. <a href="https://doi.org/10.1111/j.1600-0587.2012.07348.x">https://doi.org/10.1111/j.1600-0587.2012.07348.x</a>.
</div>
<div id="ref-dornelas2018" class="csl-entry" role="listitem">
Dornelas, Maria, Laura H. Antão, Faye Moyes, Amanda E. Bates, Anne E. Magurran, Dušan Adam, Asem A. Akhmetzhanova, et al. 2018. <span>“BioTIME: A Database of Biodiversity Time Series for the Anthropocene.”</span> <em>Global Ecology and Biogeography</em> 27 (7): 760–86. <a href="https://doi.org/10.1111/geb.12729">https://doi.org/10.1111/geb.12729</a>.
</div>
<div id="ref-fick2017" class="csl-entry" role="listitem">
Fick, Stephen E., and Robert J. Hijmans. 2017. <span>“WorldClim 2: New 1<span>-</span>Km Spatial Resolution Climate Surfaces for Global Land Areas.”</span> <em>International Journal of Climatology</em> 37 (12): 4302–15. <a href="https://doi.org/10.1002/joc.5086">https://doi.org/10.1002/joc.5086</a>.
</div>
<div id="ref-fox2017" class="csl-entry" role="listitem">
Fox, Eric W., Ryan A. Hill, Scott G. Leibowitz, Anthony R. Olsen, Darren J. Thornbrugh, and Marc H. Weber. 2017. <span>“Assessing the Accuracy and Stability of Variable Selection Methods for Random Forest Modeling in Ecology.”</span> <em>Environmental Monitoring and Assessment</em> 189 (7). <a href="https://doi.org/10.1007/s10661-017-6025-0">https://doi.org/10.1007/s10661-017-6025-0</a>.
</div>
<div id="ref-graham2003" class="csl-entry" role="listitem">
Graham, Michael H. 2003. <span>“CONFRONTING MULTICOLLINEARITY IN ECOLOGICAL MULTIPLE REGRESSION.”</span> <em>Ecology</em> 84 (11): 2809–15. <a href="https://doi.org/10.1890/02-3114">https://doi.org/10.1890/02-3114</a>.
</div>
<div id="ref-howley2005" class="csl-entry" role="listitem">
Howley, Tom, Michael G. Madden, Marie-Louise O’Connell, and Alan G. Ryder. 2005. <span>“The Effect of Principal Component Analysis on Machine Learning Accuracy with High Dimensional Spectral Data.”</span> In, 209–22. Springer London. <a href="https://doi.org/10.1007/1-84628-224-1_16">https://doi.org/10.1007/1-84628-224-1_16</a>.
</div>
<div id="ref-karger2017" class="csl-entry" role="listitem">
Karger, Dirk Nikolaus, Olaf Conrad, Jürgen Böhner, Tobias Kawohl, Holger Kreft, Rodrigo Wilber Soria-Auza, Niklaus E. Zimmermann, H. Peter Linder, and Michael Kessler. 2017. <span>“Climatologies at High Resolution for the Earth<span>’</span>s Land Surface Areas.”</span> <em>Scientific Data</em> 4 (1). <a href="https://doi.org/10.1038/sdata.2017.122">https://doi.org/10.1038/sdata.2017.122</a>.
</div>
<div id="ref-kaufman2011" class="csl-entry" role="listitem">
Kaufman, Shachar, Saharon Rosset, and Claudia Perlich. 2011. <span>“Leakage in Data Mining.”</span> <em>Proceedings of the 17th ACM SIGKDD International Conference on Knowledge Discovery and Data Mining</em>, August. <a href="https://doi.org/10.1145/2020408.2020496">https://doi.org/10.1145/2020408.2020496</a>.
</div>
<div id="ref-kessy2018" class="csl-entry" role="listitem">
Kessy, Agnan, Alex Lewin, and Korbinian Strimmer. 2018. <span>“Optimal Whitening and Decorrelation.”</span> <em>The American Statistician</em> 72 (4): 309–14. <a href="https://doi.org/10.1080/00031305.2016.1277159">https://doi.org/10.1080/00031305.2016.1277159</a>.
</div>
<div id="ref-koivunen1999" class="csl-entry" role="listitem">
Koivunen, A. C., and A. B. Kostinski. 1999. <span>“The Feasibility of Data Whitening to Improve Performance of Weather Radar.”</span> <em>Journal of Applied Meteorology</em> 38 (6): 741–49. <a href="https://doi.org/10.1175/1520-0450(1999)038<0741:tfodwt>2.0.co;2">https://doi.org/10.1175/1520-0450(1999)038&lt;0741:tfodwt&gt;2.0.co;2</a>.
</div>
<div id="ref-legendre2012" class="csl-entry" role="listitem">
Legendre, Pierre, and Louis Legendre. 2012. <em>Numerical ecology</em>. Third English edition. Vol. 20. Developments in environmental modelling, Developments in environmental modelling. Oxford, UK: Elsevier.
</div>
<div id="ref-leroy2018" class="csl-entry" role="listitem">
Leroy, Boris, Robin Delsol, Bernard Hugueny, Christine N. Meynard, Chéïma Barhoumi, Morgane Barbet-Massin, and Céline Bellard. 2018. <span>“Without Quality Presence<span></span>absence Data, Discrimination Metrics Such as TSS Can Be Misleading Measures of Model Performance.”</span> <em>Journal of Biogeography</em> 45 (9): 1994–2002. <a href="https://doi.org/10.1111/jbi.13402">https://doi.org/10.1111/jbi.13402</a>.
</div>
<div id="ref-murtaugh2009" class="csl-entry" role="listitem">
Murtaugh, Paul A. 2009. <span>“Performance of Several Variable<span>-</span>Selection Methods Applied to Real Ecological Data.”</span> <em>Ecology Letters</em> 12 (10): 1061–68. <a href="https://doi.org/10.1111/j.1461-0248.2009.01361.x">https://doi.org/10.1111/j.1461-0248.2009.01361.x</a>.
</div>
<div id="ref-nisbet2018" class="csl-entry" role="listitem">
Nisbet, Robert, Gary Miner, Ken Yale, John F. Elder, and Andrew F. Peterson. 2018. <em>Handbook of Statistical Analysis and Data Mining Applications</em>. Second edition. London: Academic Press.
</div>
<div id="ref-pearson1901" class="csl-entry" role="listitem">
Pearson, Karl. 1901. <span>“LIII. <span><em>On Lines and Planes of Closest Fit to Systems of Points in Space</em></span>.”</span> <em>The London, Edinburgh, and Dublin Philosophical Magazine and Journal of Science</em> 2 (11): 559–72. <a href="https://doi.org/10.1080/14786440109462720">https://doi.org/10.1080/14786440109462720</a>.
</div>
<div id="ref-Peterson2018" class="csl-entry" role="listitem">
Peterson, A. Townsend, Alex Asase, Dora Canhos, Sidnei de Souza, and John Wieczorek. 2018. <span>“Data Leakage and Loss in Biodiversity Informatics.”</span> <em>Biodiversity Data Journal</em> 6 (November). <a href="https://doi.org/10.3897/bdj.6.e26826">https://doi.org/10.3897/bdj.6.e26826</a>.
</div>
<div id="ref-petitpierre2016" class="csl-entry" role="listitem">
Petitpierre, Blaise, Olivier Broennimann, Christoph Kueffer, Curtis Daehler, and Antoine Guisan. 2016. <span>“Selecting Predictors to Maximize the Transferability of Species Distribution Models: Lessons from Cross<span>-</span>Continental Plant Invasions.”</span> <em>Global Ecology and Biogeography</em> 26 (3): 275–87. <a href="https://doi.org/10.1111/geb.12530">https://doi.org/10.1111/geb.12530</a>.
</div>
<div id="ref-runghen2022" class="csl-entry" role="listitem">
Runghen, Rogini, Daniel B. Stouffer, and Giulio V. Dalla Riva. 2022. <span>“Exploiting Node Metadata to Predict Interactions in Bipartite Networks Using Graph Embedding and Neural Networks.”</span> <em>Royal Society Open Science</em> 9 (8). <a href="https://doi.org/10.1098/rsos.220079">https://doi.org/10.1098/rsos.220079</a>.
</div>
<div id="ref-schölkopf1998" class="csl-entry" role="listitem">
Schölkopf, Bernhard, Alexander Smola, and Klaus-Robert Müller. 1998. <span>“Nonlinear Component Analysis as a Kernel Eigenvalue Problem.”</span> <em>Neural Computation</em> 10 (5): 1299–319. <a href="https://doi.org/10.1162/089976698300017467">https://doi.org/10.1162/089976698300017467</a>.
</div>
<div id="ref-smith2017" class="csl-entry" role="listitem">
Smith, Megan L., Megan Ruffley, Anahí Espíndola, David C. Tank, Jack Sullivan, and Bryan C. Carstens. 2017. <span>“Demographic Model Selection Using Random Forests and the Site Frequency Spectrum.”</span> <em>Molecular Ecology</em> 26 (17): 4562–73. <a href="https://doi.org/10.1111/mec.14223">https://doi.org/10.1111/mec.14223</a>.
</div>
<div id="ref-stock2023" class="csl-entry" role="listitem">
Stock, Andy, Edward J. Gregr, and Kai M. A. Chan. 2023. <span>“Data Leakage Jeopardizes Ecological Applications of Machine Learning.”</span> <em>Nature Ecology &amp; Evolution</em>, August. <a href="https://doi.org/10.1038/s41559-023-02162-1">https://doi.org/10.1038/s41559-023-02162-1</a>.
</div>
<div id="ref-thuiller2004" class="csl-entry" role="listitem">
Thuiller, Wilfried, Miguel B Araújo, and Sandra Lavorel. 2004. <span>“Do We Need Land<span>-</span>Cover Data to Model Species Distributions in Europe?”</span> <em>Journal of Biogeography</em> 31 (3): 353–61. <a href="https://doi.org/10.1046/j.0305-0270.2003.00991.x">https://doi.org/10.1046/j.0305-0270.2003.00991.x</a>.
</div>
<div id="ref-tipping1999" class="csl-entry" role="listitem">
Tipping, Michael E., and Christopher M. Bishop. 1999. <span>“Probabilistic Principal Component Analysis.”</span> <em>Journal of the Royal Statistical Society Series B: Statistical Methodology</em> 61 (3): 611–22. <a href="https://doi.org/10.1111/1467-9868.00196">https://doi.org/10.1111/1467-9868.00196</a>.
</div>
<div id="ref-tredennick2021" class="csl-entry" role="listitem">
Tredennick, Andrew T., Giles Hooker, Stephen P. Ellner, and Peter B. Adler. 2021. <span>“A Practical Guide to Selecting Models for Exploration, Inference, and Prediction in Ecology.”</span> <em>Ecology</em> 102 (6). <a href="https://doi.org/10.1002/ecy.3336">https://doi.org/10.1002/ecy.3336</a>.
</div>
<div id="ref-vasseur2004" class="csl-entry" role="listitem">
Vasseur, David A., and Peter Yodzis. 2004. <span>“THE COLOR OF ENVIRONMENTAL NOISE.”</span> <em>Ecology</em> 85 (4): 1146–52. <a href="https://doi.org/10.1890/02-3122">https://doi.org/10.1890/02-3122</a>.
</div>
<div id="ref-whittingham2006" class="csl-entry" role="listitem">
WHITTINGHAM, MARK J., PHILIP A. STEPHENS, RICHARD B. BRADBURY, and ROBERT P. FRECKLETON. 2006. <span>“Why Do We Still Use Stepwise Modelling in Ecology and Behaviour?”</span> <em>Journal of Animal Ecology</em> 75 (5): 1182–89. <a href="https://doi.org/10.1111/j.1365-2656.2006.01141.x">https://doi.org/10.1111/j.1365-2656.2006.01141.x</a>.
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    const typesetMath = (el) => {
      if (window.MathJax) {
        // MathJax Typeset
        window.MathJax.typeset([el]);
      } else if (window.katex) {
        // KaTeX Render
        var mathElements = el.getElementsByClassName("math");
        var macros = [];
        for (var i = 0; i < mathElements.length; i++) {
          var texText = mathElements[i].firstChild;
          if (mathElements[i].tagName == "SPAN") {
            window.katex.render(texText.data, mathElements[i], {
              displayMode: mathElements[i].classList.contains('display'),
              throwOnError: false,
              macros: macros,
              fleqn: false
            });
          }
        }
      }
    }
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        for (let i = 0; i < 2; i++) {
          container.appendChild(note.children[i].cloneNode(true));
        }
        typesetMath(container);
        return container.innerHTML
      } else {
        typesetMath(note);
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      typesetMath(note);
      return note.innerHTML;
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>This work is licensed under the <a href="https://creativecommons.org/licenses/by-nc/4.0/">CC BY-NC 4.0 International License</a></p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>