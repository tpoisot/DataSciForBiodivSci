<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.9">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>10&nbsp; Generating counterfactuals – Machine Learning for Biodiversity Scientists</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-c5e942a007d896c09d288e0a021963dd.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-8c0a46209ffcf3a098f65e18256def9c.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": true,
  "collapse-after": 1,
  "panel-placement": "start",
  "type": "overlay",
  "limit": 10,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar docked slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../chapters/counterfactuals.html"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Generating counterfactuals</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Machine Learning for Biodiversity Scientists</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://github.com/tpoisot/MLBS" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <a href="../Machine-Learning-for-Biodiversity-Scientists.pdf" title="Download PDF" class="quarto-navigation-tool px-1" aria-label="Download PDF"><i class="bi bi-file-pdf"></i></a>
    <div id="quarto-search" class="quarto-navigation-tool px-1" title="Search"></div>
</div>
    </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/clustering.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Clustering</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/gradientdescent.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Gradient descent</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/crossvalidation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Cross-validation</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/classification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Supervised classification</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/variableselection.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Preparing features</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/learningcurves.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Tuning hyper-parameters</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/bagging.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Bagging, ensembles, and uncertainty</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/explanations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Explaining predictions</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/counterfactuals.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Generating counterfactuals</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/squint.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">The machine learning squint</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../appendices/instructornotes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Instructor notes</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="-1">
    <h2 id="toc-title">Chapter overview</h2>
   
  <ul>
  <li><a href="#illustration-changing-the-temperature" id="toc-illustration-changing-the-temperature" class="nav-link active" data-scroll-target="#illustration-changing-the-temperature"><span class="header-section-number">10.1</span> Illustration: changing the temperature</a></li>
  <li><a href="#theory-on-counterfactuals" id="toc-theory-on-counterfactuals" class="nav-link" data-scroll-target="#theory-on-counterfactuals"><span class="header-section-number">10.2</span> Theory on counterfactuals</a>
  <ul class="collapse">
  <li><a href="#loss-function" id="toc-loss-function" class="nav-link" data-scroll-target="#loss-function"><span class="header-section-number">10.2.1</span> Loss function</a></li>
  <li><a href="#sec-counterfactuals-learningrate" id="toc-sec-counterfactuals-learningrate" class="nav-link" data-scroll-target="#sec-counterfactuals-learningrate"><span class="header-section-number">10.2.2</span> Learning rate</a></li>
  <li><a href="#optimization" id="toc-optimization" class="nav-link" data-scroll-target="#optimization"><span class="header-section-number">10.2.3</span> Optimization</a></li>
  </ul></li>
  <li><a href="#application-todo" id="toc-application-todo" class="nav-link" data-scroll-target="#application-todo"><span class="header-section-number">10.3</span> Application: todo</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion"><span class="header-section-number">10.4</span> Conclusion</a></li>
  <li><a href="#bibliography" id="toc-bibliography" class="nav-link" data-scroll-target="#bibliography">References</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/tpoisot/MLBS/blob/main/chapters/counterfactuals.qmd" class="toc-action"><i class="bi bi-github"></i>View source</a></li><li><a href="https://github.com/tpoisot/MLBS/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Generating counterfactuals</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>In <a href="explanations.html" class="quarto-xref"><span>Chapter 9</span></a>, we have introduced a methodology to re-use our model on mock inputs in order to figure out the effect of the specific value of a specific variable on the prediction that is made. This is a powerful approach to formulating explanations. In this chapter, we will introduce a related concept, namely the generation of counterfactuals.</p>
<p>Counterfactuals <span class="citation" data-cites="wachter2017">(<a href="#ref-wachter2017" role="doc-biblioref">Wachter <em>et al.</em> 2017</a>)</span> are defined as small perturbations on an actual input instance that yield the <em>opposite</em> prediction. In other words, counterfactuals are mock instances that are as close as possible to an observed data point, but that would lead the model to making the inverse recommendation.</p>
<section id="illustration-changing-the-temperature" class="level2 page-columns page-full" data-number="10.1">
<h2 data-number="10.1" class="anchored" data-anchor-id="illustration-changing-the-temperature"><span class="header-section-number">10.1</span> Illustration: changing the temperature</h2>
<p>Before introducing some elements of theory, it helps to think about what we want to achieve in a more general, intuitive way. For this chapter, we will re-use the model we ended up with in <a href="explanations.html" class="quarto-xref"><span>Chapter 9</span></a>, <strong>TK</strong></p>
<p>For example, with a temperature of 15.200000000000001 degrees, and a precipitation volume of 858.0, the model would give a probability of 0.19377392149173. You can compare with <a href="classification.html#fig-classification-decision" class="quarto-xref">Figure&nbsp;<span>5.3</span></a> to see that this is associated to a negative prediction.</p>
<p>Is there a temperature at which we would expect the model to make the opposite prediction? Perhaps the simplest approach to this question is to feed our trained model different values of the temperature, and measure the output. What if the location was a degree warmer? A degree colder? Ten?</p>
<p>This approach is both generating perturbations of our initial prediction, and expressing these predictions as a function of whether they lead the model to change its outcome. Conceptually, we are 80% of our way to understanding counterfactuals (in practical terms, we are still on square one, but let’s give it time).</p>
<p>The outcome of running this simple simulations is given in <a href="#fig-counterfactuals-illustration" class="quarto-xref">Figure&nbsp;<span>10.1</span></a>. From this figure, we can see that the closest temperature that would lead to the model predicting a presence is TODO, which requires a temperature difference of TODO.</p>
<div id="cell-fig-counterfactuals-illustration" class="cell page-columns page-full" data-execution_count="1">
<div class="cell-output cell-output-display page-columns page-full" data-execution_count="1">
<div id="fig-counterfactuals-illustration" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full" data-fig-scap="What temperature change is required to turn a prediction into the other outcome?">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-counterfactuals-illustration-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="counterfactuals_files/figure-html/fig-counterfactuals-illustration-output-1.png" data-fig-scap="What temperature change is required to turn a prediction into the other outcome?" width="4800" height="3600" class="figure-img">
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-counterfactuals-illustration-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;10.1: Effect of changing the temperature for a single observation (marked as a black dot) on the probability returned by the trained SDM (as a black line). There is a value above which the prediction leads to the positive class (the SDM predicts that the conditions are suitable to the species), marked by a dashed line. The generation of counterfactuals is a way to generalize this approach, by also introducing notions of optimality.
</figcaption>
</figure>
</div>
</div>
</div>
<p>Is this a <em>large</em> difference? This is a rather subjective question; one we can ask instead is whether this is an <em>optimal</em> difference, and specifically whether we can find other alternatives inputs to the model that would be less costly (in terms of distance) and more efficient (in terms of effect on the model).</p>
<p>At this point, it is important to note that we will not be addressing the <em>feasibility</em> of making these changes. There are specific algorithms that penalize some variables that are more difficult (or impossible) to change, but they follow the same principles as what we will discuss here. Their inner workings are, quite simply put, orders of magnitude more complex. For an example, and a discussion of why changing features that people can act upon is essential to algorithmic fairness, see <span class="citation" data-cites="schleich2021">Schleich <em>et al.</em> (<a href="#ref-schleich2021" role="doc-biblioref">2021</a>)</span>.</p>
</section>
<section id="theory-on-counterfactuals" class="level2 page-columns page-full" data-number="10.2">
<h2 data-number="10.2" class="anchored" data-anchor-id="theory-on-counterfactuals"><span class="header-section-number">10.2</span> Theory on counterfactuals</h2>
<p>In this section, we will look at the method introduced by <span class="citation" data-cites="wachter2017">Wachter <em>et al.</em> (<a href="#ref-wachter2017" role="doc-biblioref">2017</a>)</span>, and spend a bit of time linking it to concepts we have seen in other chapters of the book. In the first section, we have defined two components to the problem of generating counterfactuals: given a vector of features <span class="math inline">\(\mathbf{x}\)</span>, we want to generate a new vector of features <span class="math inline">\(\mathbf{x}'\)</span>, such that a model <span class="math inline">\(f\)</span> would return <span class="math inline">\(\hat y = f(\mathbf{x})\)</span>, and <span class="math inline">\(\hat y' \approx f(\mathbf{x}')\)</span>. Because we are working on a classification problem, we <em>might</em> assume that we want <span class="math inline">\(\hat y ' = \neg \hat y\)</span>, but recall from <a href="learningcurves.html#sec-learningcurves-probabilistic" class="quarto-xref"><span>Section 7.4.2</span></a> that we are getting to the binary classification of presence/absence by comparing the probability to an optimized threshold <span class="math inline">\(\tau\)</span>, so we can also aim for <span class="math inline">\(\hat y' = \tau + \varepsilon\)</span>, where <span class="math inline">\(\varepsilon\)</span> is a very small perturbation (positive or negative) that would make us cross the decision threshold.</p>
<section id="loss-function" class="level3" data-number="10.2.1">
<h3 data-number="10.2.1" class="anchored" data-anchor-id="loss-function"><span class="header-section-number">10.2.1</span> Loss function</h3>
<p>In <a href="gradientdescent.html" class="quarto-xref"><span>Chapter 3</span></a>, we have established the idea of a loss function, that measures how far away a specific instance is to an optimal solution. What does it means for a countefactual to be optimal? We want the distance between <span class="math inline">\(\hat y\)</span> and <span class="math inline">\(\hat y'\)</span> to be as small as possible (we are meeting the criteria of “the prediction has changed”), while also ensuring that the distance between <span class="math inline">\(\mathbf{x}\)</span> and <span class="math inline">\(\mathbf{x}'\)</span> remains small (we are meeting the criteria of parsimonious explanations).</p>
<p><span class="citation" data-cites="wachter2017">Wachter <em>et al.</em> (<a href="#ref-wachter2017" role="doc-biblioref">2017</a>)</span> suggest that the appropriate loss function to use is</p>
<p><span id="eq-counterfactuals-loss"><span class="math display">\[
L(\mathbf{x}, \mathbf{x}', \hat y', f) = \lambda \times (f(\mathbf{x}') - \hat y')^2 + \text{d}(\mathbf{x}, \mathbf{x}')
\tag{10.1}\]</span></span></p>
<p>where <span class="math inline">\(\lambda\)</span> is a learning rate (as defined in <a href="gradientdescent.html#sec-gradientdescent-learningrate" class="quarto-xref"><span>Section 3.3.4</span></a>), and <span class="math inline">\(\text{d}\)</span> is a distance function between the input vectors. In this formulation, the loss function is not handling categorical predictors (which is an acceptable compromise, because we are not using any in this illustration).</p>
<p>In <span class="citation" data-cites="wachter2017">Wachter <em>et al.</em> (<a href="#ref-wachter2017" role="doc-biblioref">2017</a>)</span>, the distance function for <span class="math inline">\(m\)</span> features is defined as</p>
<p><span id="eq-counterfactuals-distance"><span class="math display">\[
\text{d}(\mathbf{x}, \mathbf{x}') = \sum_{i=1}^{m}\frac{\|\mathbf{x}_i-\mathbf{x}_i'\|}{\text{MAD}_i}
\tag{10.2}\]</span></span></p>
<p>where <span class="math inline">\(\text{MAD}_i\)</span> is the median absolute deviation for this feature over the entire dataset. The median absolute deviation for an instance <span class="math inline">\(j\)</span> of a feature <span class="math inline">\(i\)</span> drawn from the entire training dataset <span class="math inline">\(\mathbf{X}\)</span> is</p>
<p><span class="math display">\[
\text{median}\left(\|\mathbf{x}_i-\text{median}(\mathbf{X}_{,j})\|\right) \,.
\]</span></p>
<p>This indicator is very robust to outliers, and returns a scale-free value that allows comparing the distributions of different variables. Although MAD can be used to <em>detect</em> outliers <span class="citation" data-cites="shimizu2022 benhadi-marín2018">(<a href="#ref-benhadi-marín2018" role="doc-biblioref">Benhadi-Marín 2018</a>; <a href="#ref-shimizu2022" role="doc-biblioref">Shimizu 2022</a>)</span>, this is not its purpose here: instead, it is used to penalize datapoints that would be outliers in the space of distances we care about (namely, between <span class="math inline">\(\mathbf{x}\)</span> and <span class="math inline">\(\mathbf{x}'\)</span>).</p>
</section>
<section id="sec-counterfactuals-learningrate" class="level3 page-columns page-full" data-number="10.2.2">
<h3 data-number="10.2.2" class="anchored" data-anchor-id="sec-counterfactuals-learningrate"><span class="header-section-number">10.2.2</span> Learning rate</h3>
<p>In <a href="#eq-counterfactuals-distance" class="quarto-xref">Equation&nbsp;<span>10.2</span></a>, we introduced a learning rate <span class="math inline">\(\lambda\)</span>. The interpretation of this term is relatively straightforward, as it measures the <em>relative</em> importance of getting close to <span class="math inline">\(\hat y'\)</span> compared to keeping <span class="math inline">\(\mathbf{x}'\)</span> close to <span class="math inline">\(\mathbf{x}\)</span>. Therefore, using <span class="math inline">\(\lambda = 2\)</span> means that getting a good switch of the prediction is twice as important as keeping a parsimonious counterfactual.</p>
<p>Because the <em>a priori</em> value of <span class="math inline">\(\lambda\)</span> may not be intuitive to define, we can rely on the techniques introduced in <a href="learningcurves.html" class="quarto-xref"><span>Chapter 7</span></a>, and treat this as an hyper-parameter. Alternatively, <span class="citation" data-cites="wachter2017">Wachter <em>et al.</em> (<a href="#ref-wachter2017" role="doc-biblioref">2017</a>)</span> suggest the use of a <em>threshold</em> <span class="math inline">\(\sigma\)</span> for the distance between the outcome of <span class="math inline">\(f(\mathbf{x}')\)</span> and the desired value of <span class="math inline">\(\hat y'\)</span>, which is a trick used in other techniques like acceptance-rejection sampling <span class="citation" data-cites="flury1990">(<a href="#ref-flury1990" role="doc-biblioref">Flury 1990</a>)</span>. This threshold too must be decided upon before running the algorithm. Note that because the distance component of the loss function (<a href="#eq-counterfactuals-distance" class="quarto-xref">Equation&nbsp;<span>10.2</span></a>) uses the median absolute deviation, we can follow <span class="citation" data-cites="leys2013">Leys <em>et al.</em> (<a href="#ref-leys2013" role="doc-biblioref">2013</a>)</span> that suggest to use the thresholds introduced by <span class="citation" data-cites="miller1991">Miller (<a href="#ref-miller1991" role="doc-biblioref">1991</a>)</span> to also eliminate proposals of <span class="math inline">\(\mathbf{x}'\)</span> that are too far away from the original input <span class="math inline">\(\mathbf{x}\)</span>.</p>
<div id="cell-fig-counterfactuals-loss" class="cell page-columns page-full" data-execution_count="1">
<div class="cell-output cell-output-display page-columns page-full" data-execution_count="1">
<div id="fig-counterfactuals-loss" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full" data-fig-scap="Loss when changing the temperature for a single observation">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-counterfactuals-loss-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="counterfactuals_files/figure-html/fig-counterfactuals-loss-output-1.png" data-fig-scap="Loss when changing the temperature for a single observation" width="4800" height="3600" class="figure-img">
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-counterfactuals-loss-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;10.2: Consequences of changing only the temperature (as in <a href="#fig-counterfactuals-illustration" class="quarto-xref">Figure&nbsp;<span>10.1</span></a>) on the loss function (<a href="#eq-counterfactuals-loss" class="quarto-xref">Equation&nbsp;<span>10.1</span></a>) for a single prediction. Notice that changing the value of the learning rate (indicated by the color gradient) to get to a point where we can conclude that the suggested counterfactual is optimal.
</figcaption>
</figure>
</div>
</div>
</div>
<p>In <a href="#fig-counterfactuals-loss" class="quarto-xref">Figure&nbsp;<span>10.2</span></a>, we can see the effect of changing the learning rate on the value of the loss function when only changing the temperature as we did for <a href="#fig-counterfactuals-illustration" class="quarto-xref">Figure&nbsp;<span>10.1</span></a>. Notice that for values of the learning rate that are too small, there is not counterfactual for which the loss is <em>lower</em> than the original datapoint, and therefore we need to increase the learning rate until the optimum (smallest point that brings us above the threshold) can be reached. The shape of the response of the loss function to the change in temperature is also informative. In one direction, it increases linearly: <span class="math inline">\(\mathbf{x}'\)</span> is getting further and further away from <span class="math inline">\(\mathbf{x}\)</span> without the <em>prediction</em> getting closer to <span class="math inline">\(\hat y'\)</span>. On the other direction, it is more or less hump-shaped, with an optimal point. When we increase the learning rate (possibly by <em>a lot</em>), the behavior in which <span class="math inline">\(\mathbf{x}\)</span> is an optimum of this problem disappears.</p>
<p><strong>TK</strong> the threshold is important because it ensures we will only look at the space of parameters around the optimal solution - but making assumptions about the shape of the loss landscape</p>
</section>
<section id="optimization" class="level3 page-columns page-full" data-number="10.2.3">
<h3 data-number="10.2.3" class="anchored" data-anchor-id="optimization"><span class="header-section-number">10.2.3</span> Optimization</h3>
<p>In <a href="gradientdescent.html" class="quarto-xref"><span>Chapter 3</span></a>, we were able to write down an analytical expression of the gradient for our model (and its associated loss function). This may not be the case for the specific problem we are trying to solve. In addition, the surface of the loss function over possibly many parameters may not be smooth; in fact, if we used tree-based classifiers, it would be a guarantee that it would not. For this reason, we will introduce alternative methods to perform the optimization. The general shape of the problem we are tying to solve is the same as in <a href="gradientdescent.html" class="quarto-xref"><span>Chapter 3</span></a>: given an input <span class="math inline">\(\mathbf{x}\)</span>, we are interested in generating <span class="math inline">\(\mathbf{x}'\)</span> that minimizes loss.</p>
<p>The specific details of</p>
<p><span class="citation" data-cites="nelder1965">Nelder &amp; Mead (<a href="#ref-nelder1965" role="doc-biblioref">1965</a>)</span></p>
<p>also simulated annealing</p>
<p>But let us get back to the issue we discussed in <a href="#sec-counterfactuals-learningrate" class="quarto-xref"><span>Section 10.2.2</span></a>: the value of <span class="math inline">\(\lambda\)</span> is not easy to determine <em>a priori</em>. And as we show in <a href="#fig-counterfactuals-illustration" class="quarto-xref">Figure&nbsp;<span>10.1</span></a>, a learning rate that is too low can get us to a situation where <span class="math inline">\(\mathbf{x}\)</span> is a <em>local</em> optimal for the loss function, which would make the generation of counterfactuals more difficult. On the other hand, a learning rate that is introducing the problems we discussed in <a href="gradientdescent.html#sec-gradientdescent-learningrate" class="quarto-xref"><span>Section 3.3.4</span></a>. We want the valuer of the learning rate to be “just right”. For this reason, a common approach is to re-start the algorithm to generate a counterfactual, and if this counterfactual is not adequate, to re-try with a larger learning rate.</p>
<div id="cell-fig-counterfactuals-optimize" class="cell page-columns page-full" data-execution_count="1">
<div class="cell-output cell-output-display page-columns page-full" data-execution_count="1">
<div id="fig-counterfactuals-optimize" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full" data-fig-scap="Sequential increase of the learning rate until the threshold is reached">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-counterfactuals-optimize-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="counterfactuals_files/figure-html/fig-counterfactuals-optimize-output-1.png" data-fig-scap="Sequential increase of the learning rate until the threshold is reached" width="4800" height="3600" class="figure-img">
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-counterfactuals-optimize-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;10.3: Because the learning rate is difficult to guess, we start with a low value of <span class="math inline">\(\lambda\)</span>, and increase it (here by 2 percent) until the counterfactual is within a small range of the desired <span class="math inline">\(\hat y'\)</span> value. This method sets a <em>tolerance</em> on the error we are willing to make on the final prediction, and optimizes the learning rate accordingly. In a sense, this is an instance of a learning curve as in <a href="learningcurves.html" class="quarto-xref"><span>Chapter 7</span></a>.
</figcaption>
</figure>
</div>
</div>
</div>
<p>This approach is illustrated in <a href="#fig-counterfactuals-optimize" class="quarto-xref">Figure&nbsp;<span>10.3</span></a>. Note that there is still a variation in whether the counterfactual is within the threshold when we use a large learning rate. This is because the optimization process is stochastic, and can have worse performance when we start the Nelder-Mead algorithm (which we use in this chapter) with less than ideal configurations. In practice, for the rest of the examples, we will generate more counterfactuals than we need, and <em>filter</em> the ones that are within the threshold.</p>
</section>
</section>
<section id="application-todo" class="level2 page-columns page-full" data-number="10.3">
<h2 data-number="10.3" class="anchored" data-anchor-id="application-todo"><span class="header-section-number">10.3</span> Application: todo</h2>
<div id="cell-fig-counterfactuals-generation" class="cell page-columns page-full" data-execution_count="1">
<div class="cell-output cell-output-display page-columns page-full" data-execution_count="1">
<div id="fig-counterfactuals-generation" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full" data-fig-scap="Generation of a sample of counterfactuals">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-counterfactuals-generation-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="counterfactuals_files/figure-html/fig-counterfactuals-generation-output-1.png" data-fig-scap="Generation of a sample of counterfactuals" width="4800" height="3600" class="figure-img">
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-counterfactuals-generation-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;10.4: Generation of a number of counterfactual samples for an actual observation (black diamond), color-coded by whether or not the prediction for each counterfactual is positive or negative. The target <span class="math inline">\(\hat y'\)</span> is set to <span class="math inline">\(\tau + 0.015\)</span>, which explains why the generated counterfactuals lie on the separation between the positive and the negative class.
</figcaption>
</figure>
</div>
</div>
</div>
<p>filter by conditions existing in the dataset</p>
<div id="20" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">filter!</span>(p <span class="op">-&gt;</span> <span class="fu">predict</span>(model, p), proposals)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>L <span class="op">=</span> [<span class="fu">loss</span>(model, cnd, xp, model.τ <span class="op">+</span> <span class="fl">0.015</span>, <span class="fl">500.0</span>; threshold<span class="op">=</span><span class="cn">false</span>) for xp <span class="kw">in</span> proposals]</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>ord <span class="op">=</span> <span class="fu">partialsortperm</span>(L, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>[proposals[o][model.v] for o <span class="kw">in</span> ord] <span class="co"># Turn into a table</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>[<span class="fu">abs</span>.(cnd[model.v] <span class="op">.-</span> proposals[o][model.v])<span class="op">./</span>cnd[model.v]<span class="op">.*</span><span class="fl">100</span> for o <span class="kw">in</span> ord] <span class="co"># Turn into a table</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>10-element Vector{Vector{Float64}}:
 [5.47509297455585, 0.0037789508335125477, 0.004051707395507397, 0.00023371253218202175, 3.523998974939417]
 [5.638139444948745, 0.01094960006320096, 0.000301954314993456, 0.0001896116535561367, 0.20809445911099683]
 [5.507476382581126, 0.004559599992894036, 0.003636276835748525, 0.0023925619316266284, 1.6121391508148508]
 [5.593087108196402, 0.01799158818929929, 0.00038350343333530513, 0.0007169308876206078, 6.22742839510209]
 [5.545207493870233, 0.009111585450868943, 0.001560997508910754, 0.00047218937922067567, 7.968939709546476]
 [5.674853972303047, 0.013160236183382745, 0.0004051677759106983, 0.0002742496202364329, 0.6810814813003366]
 [5.631003342184489, 0.006367713996650497, 0.005064634135539014, 0.0014148079316051495, 0.011452001412592122]
 [5.669301219972049, 0.029691355727609142, 0.0008677163639620547, 0.00030868702228450257, 7.750052410530607]
 [5.599789126798995, 0.0046806088161831004, 0.002319358790053462, 0.005491494043085366, 2.427632620066744]
 [5.803275062602889, 0.008295570571049654, 0.0030558493717551243, 0.0010770108131596073, 1.8619468716207126]</code></pre>
</div>
</div>
</section>
<section id="conclusion" class="level2" data-number="10.4">
<h2 data-number="10.4" class="anchored" data-anchor-id="conclusion"><span class="header-section-number">10.4</span> Conclusion</h2>


<div id="3ade8a4a-fb1d-4a6c-8409-ac45482d5fc9" class="hidden">

</div>
</section>
<section id="bibliography" class="level1 unnumbered">
<h1 class="unnumbered">References</h1>
<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-benhadi-marín2018" class="csl-entry" role="listitem">
Benhadi-Marín, J. (2018). <a href="https://doi.org/10.1007/s10531-018-1602-2">A conceptual framework to deal with outliers in ecology</a>. <em>Biodiversity and Conservation</em>, 27, 3295–3300.
</div>
<div id="ref-flury1990" class="csl-entry" role="listitem">
Flury, B.D. (1990). <a href="https://doi.org/10.1137/1032082">Acceptance<span></span>Rejection Sampling Made Easy</a>. <em>SIAM Review</em>, 32, 474–476.
</div>
<div id="ref-leys2013" class="csl-entry" role="listitem">
Leys, C., Ley, C., Klein, O., Bernard, P. &amp; Licata, L. (2013). <a href="https://doi.org/10.1016/j.jesp.2013.03.013">Detecting outliers: Do not use standard deviation around the mean, use absolute deviation around the median</a>. <em>Journal of Experimental Social Psychology</em>, 49, 764–766.
</div>
<div id="ref-miller1991" class="csl-entry" role="listitem">
Miller, J. (1991). <a href="https://doi.org/10.1080/14640749108400962">Short Report: Reaction Time Analysis with Outlier Exclusion: Bias Varies with Sample Size</a>. <em>The Quarterly Journal of Experimental Psychology Section A</em>, 43, 907–912.
</div>
<div id="ref-nelder1965" class="csl-entry" role="listitem">
Nelder, J.A. &amp; Mead, R. (1965). <a href="https://doi.org/10.1093/comjnl/7.4.308">A Simplex Method for Function Minimization</a>. <em>The Computer Journal</em>, 7, 308–313.
</div>
<div id="ref-schleich2021" class="csl-entry" role="listitem">
Schleich, M., Geng, Z., Zhang, Y. &amp; Suciu, D. (2021). <a href="https://doi.org/10.14778/3461535.3461555">GeCo</a>. <em>Proceedings of the VLDB Endowment</em>, 14, 1681–1693.
</div>
<div id="ref-shimizu2022" class="csl-entry" role="listitem">
Shimizu, Y. (2022). <a href="https://doi.org/10.3389/fpsyg.2021.819854">Multiple desirable methods in outlier detection of univariate data with r source codes</a>. <em>Frontiers in Psychology</em>, 12.
</div>
<div id="ref-wachter2017" class="csl-entry" role="listitem">
Wachter, S., Mittelstadt, B. &amp; Russell, C. (2017). <a href="https://doi.org/10.2139/ssrn.3063289">Counterfactual Explanations Without Opening the Black Box: Automated Decisions and the GDPR</a>. <em>SSRN Electronic Journal</em>.
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>This work is licensed under the <a href="https://creativecommons.org/licenses/by-nc/4.0/">CC BY-NC 4.0 International License</a></p>
<div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/tpoisot/MLBS/blob/main/chapters/counterfactuals.qmd" class="toc-action"><i class="bi bi-github"></i>View source</a></li><li><a href="https://github.com/tpoisot/MLBS/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>